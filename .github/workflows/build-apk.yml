name: Build Android APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Set up Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Cache buildozer global directory
      uses: actions/cache@v4
      with:
        path: .buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}
        
    - name: Cache buildozer directory
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: buildozer-${{ hashFiles('buildozer.spec') }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3 \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-wheel \
          python3-venv \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo6 \
          cmake \
          libffi8 \
          libgmp-dev \
          libmpc-dev \
          libmpfr-dev \
          make \
          wget \
          zip \
          unzip \
          openjdk-17-jdk \
          autoconf \
          libtool \
          pkg-config
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.33
        pip install kivy[base]
        
    - name: Install app dependencies
      run: |
        # Install Android-compatible dependencies
        if [ -f requirements_android.txt ]; then
          pip install -r requirements_android.txt
        else
          # Fallback to manual installation
          pip install pandas numpy
        fi
        
    - name: Verify mobile files
      run: |
        if [ ! -f main_mobile.py ]; then
          echo "main_mobile.py not found!"
          exit 1
        fi
        if [ ! -f mobile_stock_analyzer.py ]; then
          echo "mobile_stock_analyzer.py not found!"
          exit 1
        fi
        
    - name: Verify buildozer.spec
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "buildozer.spec not found!"
          exit 1
        fi
        cat buildozer.spec
        
    - name: Download and setup NDK 23c
      run: |
        # Create NDK directory
        sudo mkdir -p /usr/local/lib/android/sdk/ndk
        
        # Download NDK 23c
        wget -q https://dl.google.com/android/repository/android-ndk-r23c-linux.zip
        unzip -q android-ndk-r23c-linux.zip
        sudo mv android-ndk-r23c /usr/local/lib/android/sdk/ndk/23.2.8568313
        
        # Set permissions
        sudo chmod -R 755 /usr/local/lib/android/sdk/ndk/23.2.8568313
        
        # Set NDK environment variables
        echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/23.2.8568313" >> $GITHUB_ENV
        echo "ANDROID_NDK=/usr/local/lib/android/sdk/ndk/23.2.8568313" >> $GITHUB_ENV
        
        # Verify NDK installation
        ls -la /usr/local/lib/android/sdk/ndk/23.2.8568313
        
    - name: Build APK with buildozer
      run: |
        # Set environment variables
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export ANDROID_HOME=$ANDROID_HOME
        export ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/23.2.8568313
        export ANDROID_NDK=/usr/local/lib/android/sdk/ndk/23.2.8568313
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        # Print environment info for debugging
        echo "=== Environment Info ==="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "Python version: $(python --version)"
        echo "Buildozer version: $(buildozer version)"
        echo "Java version: $(java -version)"
        
        # Accept Android SDK licenses
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # Clean previous builds
        buildozer android clean || true
        
        # Build the APK with verbose output
        buildozer -v android debug
        
    - name: List build outputs
      run: |
        echo "Contents of bin directory:"
        ls -la bin/ || echo "bin directory not found"
        echo "Contents of .buildozer directory:"
        find .buildozer -name "*.apk" -type f || echo "No APK files found in .buildozer"
        
    - name: Find APK file
      id: find_apk
      run: |
        APK_PATH=$(find . -name "*.apk" -type f | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "No APK file found!"
          exit 1
        fi
        echo "APK found at: $APK_PATH"
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        
        # Get APK info
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        APK_NAME=$(basename "$APK_PATH")
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: ${{ steps.find_apk.outputs.apk_path }}
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.find_apk.outputs.apk_path }}
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸ“± æ™ºèƒ½è‚¡ç¥¨åˆ†æ Android APK
          
          ### ğŸ“¦ æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **APKå¤§å°**: ${{ steps.find_apk.outputs.apk_size }}
          - **æ–‡ä»¶å**: ${{ steps.find_apk.outputs.apk_name }}
          
          ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
          - æ™ºèƒ½é€‰è‚¡ï¼šæ”¯æŒè‡ªç„¶è¯­è¨€è¾“å…¥é€‰è‚¡è§„åˆ™
          - ä¸ªè‚¡åˆ†æï¼šè¯¦ç»†çš„è‚¡ç¥¨æŠ€æœ¯åˆ†æ
          - ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šä¸“ä¸ºAndroidè®¾å¤‡ä¼˜åŒ–çš„ç•Œé¢
          - å®æ—¶æ•°æ®ï¼šé›†æˆå¤šä¸ªæ•°æ®æºè·å–æœ€æ–°è‚¡ç¥¨ä¿¡æ¯
          
          ### ğŸ“² å®‰è£…è¯´æ˜
          1. ä¸‹è½½APKæ–‡ä»¶åˆ°Androidè®¾å¤‡
          2. å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          4. ç¡®ä¿è®¾å¤‡æœ‰ç½‘ç»œè¿æ¥ä»¥è·å–è‚¡ç¥¨æ•°æ®
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - éœ€è¦Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬
          - éœ€è¦ç½‘ç»œæƒé™ä»¥è·å–è‚¡ç¥¨æ•°æ®
          - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´åˆå§‹åŒ–
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Comment PR with APK info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const apkPath = '${{ steps.find_apk.outputs.apk_path }}';
          const apkSize = '${{ steps.find_apk.outputs.apk_size }}';
          const apkName = '${{ steps.find_apk.outputs.apk_name }}';
          
          const comment = `## ğŸ“± APK æ„å»ºæˆåŠŸï¼
          
          **æ–‡ä»¶ä¿¡æ¯:**
          - ğŸ“¦ æ–‡ä»¶å: \`${apkName}\`
          - ğŸ“ æ–‡ä»¶å¤§å°: ${apkSize}
          - â° æ„å»ºæ—¶é—´: ${new Date().toISOString()}
          
          **ä¸‹è½½é“¾æ¥:**
          APKæ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub Actions Artifactsï¼Œå¯ä»¥åœ¨ [Actions é¡µé¢](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ä¸‹è½½ã€‚
          
          **æµ‹è¯•è¯´æ˜:**
          1. ä¸‹è½½APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå®‰è£…
          3. æµ‹è¯•ä¸»è¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸
          4. åé¦ˆä»»ä½•é—®é¢˜æˆ–å»ºè®®`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });